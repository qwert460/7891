-- Doors æ¸¸æˆè„šæœ¬
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local TweenService = game:GetService("TweenService")

-- æˆ¿é—´ç®¡ç†å™¨
local RoomManager = {}
RoomManager.__index = RoomManager

function RoomManager.new()
    local self = setmetatable({}, RoomManager)
    self.rooms = {}
    self.currentRoom = 0
    self.maxRooms = 100
    return self
end

-- é—¨ç±»
local Door = {}
Door.__index = Door

function Door.new(model)
    local self = setmetatable({}, Door)
    self.model = model
    self.isOpen = false
    self.isLocked = false
    self.handle = model:WaitForChild("Handle")
    self.hinge = model:WaitForChild("Hinge")
    return self
end

function Door:Open()
    if self.isOpen or self.isLocked then return end
    
    self.isOpen = true
    local tweenInfo = TweenInfo.new(
        0.5,
        Enum.EasingStyle.Quad,
        Enum.EasingDirection.Out
    )
    
    local goal = {}
    if self.model.PrimaryPart then
        goal.Orientation = Vector3.new(0, 90, 0)
        local tween = TweenService:Create(self.model.PrimaryPart, tweenInfo, goal)
        tween:Play()
    end
end

function Door:Lock()
    self.isLocked = true
    -- é—¨é”å®šæ•ˆæœ
    if self.handle then
        local handleTween = TweenService:Create(
            self.handle,
            TweenInfo.new(0.2),
            {Color = Color3.fromRGB(255, 0, 0)}
        )
        handleTween:Play()
    end
end

-- ç©å®¶å¤„ç†å™¨
local PlayerHandler = {}

function PlayerHandler:Init(player)
    local character = player.Character or player.CharacterAdded:Wait()
    local humanoid = character:WaitForChild("Humanoid")
    local hrp = character:WaitForChild("HumanoidRootPart")
    
    -- åˆ›å»ºç©å®¶GUI
    local gui = Instance.new("ScreenGui")
    gui.Parent = player.PlayerGui
    
    -- åˆ›å»ºé’¥åŒ™è®¡æ•°å™¨
    local keyCounter = Instance.new("TextLabel")
    keyCounter.Size = UDim2.new(0, 200, 0, 50)
    keyCounter.Position = UDim2.new(0, 20, 0, 20)
    keyCounter.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
    keyCounter.BackgroundTransparency = 0.5
    keyCounter.TextColor3 = Color3.fromRGB(255, 255, 255)
    keyCounter.Text = "ğŸ”‘ é’¥åŒ™: 0"
    keyCounter.Parent = gui
    
    player:SetAttribute("Keys", 0)
end

-- å®ä½“ç®¡ç†å™¨ï¼ˆæ€ªç‰©ï¼‰
local EntityManager = {}
EntityManager.__index = EntityManager

function EntityManager.new()
    local self = setmetatable({}, EntityManager)
    self.entities = {}
    return self
end

function EntityManager:SpawnEntity(entityType, room)
    local entity = Instance.new("Model")
    entity.Name = entityType
    
    -- åˆ›å»ºç¢°æ’ç®±
    local part = Instance.new("Part")
    part.Size = Vector3.new(4, 6, 4)
    part.BrickColor = BrickColor.new("Really black")
    part.Anchored = false
    part.CanCollide = true
    part.Parent = entity
    
    local humanoid = Instance.new("Humanoid")
    humanoid.Parent = entity
    
    entity.PrimaryPart = part
    
    -- éšæœºä½ç½®
    local position = room.Position + Vector3.new(
        math.random(-10, 10),
        0,
        math.random(-10, 10)
    )
    entity:SetPrimaryPartCFrame(CFrame.new(position))
    entity.Parent = workspace.Entities
    
    table.insert(self.entities, entity)
    
    -- AI è¡Œä¸º
    self:CreateAI(entity)
end

function EntityManager:CreateAI(entity)
    spawn(function()
        while entity and entity.Parent do
            wait(math.random(1, 3))
            
            -- å¯»æ‰¾æœ€è¿‘çš„ç©å®¶
            local nearestPlayer = nil
            local shortestDistance = math.huge
            
            for _, player in pairs(Players:GetPlayers()) do
                local character = player.Character
                if character and character:FindFirstChild("HumanoidRootPart") then
                    local hrp = character.HumanoidRootPart
                    local distance = (entity.PrimaryPart.Position - hrp.Position).Magnitude
                    
                    if distance < shortestDistance and distance < 30 then
                        shortestDistance = distance
                        nearestPlayer = hrp
                    end
                end
            end
            
            if nearestPlayer then
                -- æœç©å®¶ç§»åŠ¨
                local direction = (nearestPlayer.Position - entity.PrimaryPart.Position).Unit
                local newPosition = entity.PrimaryPart.Position + direction * 2
                
                local tween = TweenService:Create(
                    entity.PrimaryPart,
                    TweenInfo.new(0.5),
                    {CFrame = CFrame.new(newPosition)}
                )
                tween:Play()
            end
        end
    end)
end

-- ç‰©å“ç³»ç»Ÿ
local ItemManager = {}

function ItemManager:CreateKey(position)
    local key = Instance.new("Part")
    key.Size = Vector3.new(1, 0.2, 0.5)
    key.BrickColor = BrickColor.new("Bright yellow")
    key.Material = Enum.Material.Neon
    key.Anchored = false
    key.CanCollide = true
    key.Position = position
    key.Parent = workspace.Items
    
    -- æ·»åŠ è§¦ç¢°æ£€æµ‹
    local clickDetector = Instance.new("ClickDetector")
    clickDetector.Parent = key
    clickDetector.MaxActivationDistance = 10
    
    clickDetector.MouseClick:Connect(function(player)
        key:Destroy()
        local currentKeys = player:GetAttribute("Keys") or 0
        player:SetAttribute("Keys", currentKeys + 1)
        
        -- æ›´æ–°GUI
        if player.PlayerGui:FindFirstChild("ScreenGui") then
            local keyCounter = player.PlayerGui.ScreenGui:FindFirstChild("TextLabel")
            if keyCounter then
                keyCounter.Text = "ğŸ”‘ é’¥åŒ™: " .. tostring(currentKeys + 1)
            end
        end
    end)
    
    -- æ—‹è½¬åŠ¨ç”»
    spawn(function()
        while key and key.Parent do
            key.CFrame = key.CFrame * CFrame.Angles(0, math.rad(5), 0)
            wait(0.1)
        end
    end)
end

-- ä¸»æ¸¸æˆå¾ªç¯
local gameManager = {
    roomManager = RoomManager.new(),
    entityManager = EntityManager.new()
}

-- ç©å®¶åŠ å…¥å¤„ç†
Players.PlayerAdded:Connect(function(player)
    print(player.Name .. " åŠ å…¥äº†æ¸¸æˆ")
    PlayerHandler:Init(player)
    
    -- ç”Ÿæˆç¬¬ä¸€ä¸ªæˆ¿é—´
    local startRoom = Instance.new("Model")
    startRoom.Name = "Room_0"
    startRoom.Parent = workspace.Rooms
    
    local floor = Instance.new("Part")
    floor.Size = Vector3.new(30, 1, 30)
    floor.BrickColor = BrickColor.new("Dark gray")
    floor.Anchored = true
    floor.Parent = startRoom
    
    local walls = {}
    for i = 1, 4 do
        local wall = Instance.new("Part")
        wall.Size = Vector3.new(30, 10, 1)
        wall.BrickColor = BrickColor.new("Medium stone grey")
        wall.Anchored = true
        wall.Parent = startRoom
        table.insert(walls, wall)
    end
    
    -- è®¾ç½®å¢™å£ä½ç½®
    walls[1].Position = Vector3.new(0, 5, 15)  -- å‰å¢™
    walls[2].Position = Vector3.new(0, 5, -15) -- åå¢™
    walls[3].Position = Vector3.new(15, 5, 0)  -- å³å¢™
    walls[4].Position = Vector3.new(-15, 5, 0) -- å·¦å¢™
    
    -- åˆ›å»ºé—¨
    local doorModel = Instance.new("Model")
    doorModel.Name = "Door"
    
    local doorPart = Instance.new("Part")
    doorPart.Size = Vector3.new(4, 7, 0.5)
    doorPart.BrickColor = BrickColor.new("Brown")
    doorPart.Anchored = false
    doorPart.CanCollide = true
    doorPart.Parent = doorModel
    
    local hinge = Instance.new("Part")
    hinge.Size = Vector3.new(0.5, 7, 0.5)
    hinge.Visible = false
    hinge.Anchored = true
    hinge.CanCollide = false
    hinge.Parent = doorModel
    
    doorModel.PrimaryPart = doorPart
    doorModel:SetPrimaryPartCFrame(CFrame.new(0, 2.5, 14.5))
    doorModel.Parent = startRoom
    
    local door = Door.new(doorModel)
    
    -- æ·»åŠ é—¨äº¤äº’
    local proximityPrompt = Instance.new("ProximityPrompt")
    proximityPrompt.Parent = doorPart
    proximityPrompt.ActionText = "å¼€é—¨"
    proximityPrompt.HoldDuration = 0
    proximityPrompt.MaxActivationDistance = 10
    
    proximityPrompt.Triggered:Connect(function(player)
        door:Open()
        
        -- æœ‰å‡ ç‡ç”Ÿæˆå®ä½“
        if math.random(1, 5) == 1 then
            gameManager.entityManager:SpawnEntity("Seeker", startRoom)
        end
        
        -- ç”Ÿæˆé’¥åŒ™
        if math.random(1, 3) == 1 then
            gameManager.itemManager:CreateKey(startRoom.Position + Vector3.new(5, 1, 5))
        end
    end)
end)

-- ç©å®¶ç¦»å¼€å¤„ç†
Players.PlayerRemoving:Connect(function(player)
    print(player.Name .. " ç¦»å¼€äº†æ¸¸æˆ")
end)

-- åˆå§‹åŒ–
spawn(function()
    workspace.Rooms:ClearAllChildren()
    workspace.Entities:ClearAllChildren()
    workspace.Items:ClearAllChildren()
    
    print("DOORS æ¸¸æˆå·²å¯åŠ¨!")
end)
